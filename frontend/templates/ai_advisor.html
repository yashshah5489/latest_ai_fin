{% extends "base.html" %}

{% block title %}AI Advisor - Smart AI Financial Analyzer{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: calc(100vh - 300px);
        min-height: 500px;
        overflow-y: auto;
        padding: 20px;
        background-color: var(--dark-card-bg);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px;
    }
    
    .typing-indicator span {
        height: 10px;
        width: 10px;
        float: left;
        margin: 0 3px;
        background-color: var(--light-text);
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }
    
    .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
    }
    
    .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
    }
    
    .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
    }
    
    @keyframes blink {
        50% {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4">AI Financial Advisor</h1>
            <p class="text-muted">Get personalized financial advice and insights from our AI advisor.</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Chat Interface -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="me-3 rounded-circle bg-primary p-2 text-white">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">AI Advisor Chat</h5>
                            <small class="text-muted">Powered by GROQ LLM</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="chat-container" class="chat-container">
                        <!-- Initial welcome message -->
                        <div class="message assistant">
                            <p>ðŸ‘‹ Hello! I'm your AI Financial Advisor, specialized in Indian financial markets and regulations. How can I help you today?</p>
                            <p>You can ask me about:</p>
                            <ul>
                                <li>Investment strategies for Indian markets</li>
                                <li>Mutual funds, stocks, and other investment options</li>
                                <li>Tax planning and compliance in India</li>
                                <li>Retirement planning and financial goals</li>
                                <li>Risk assessment and portfolio diversification</li>
                            </ul>
                        </div>
                        
                        <!-- Chat messages will be added here -->
                        {% for message in chat_history %}
                        <div class="message {{ message.role }}">
                            {{ message.content|safe }}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="p-3 border-top">
                        <form id="chat-form" class="d-flex">
                            <input type="text" id="chat-input" class="form-control me-2" placeholder="Type your financial question here..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Suggested Questions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Suggested Questions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start suggested-question">
                            How should I invest â‚¹10,000 per month?
                        </button>
                        <button class="btn btn-outline-primary text-start suggested-question">
                            What is the difference between ELSS and PPF?
                        </button>
                        <button class="btn btn-outline-primary text-start suggested-question">
                            How can I reduce my income tax liability?
                        </button>
                        <button class="btn btn-outline-primary text-start suggested-question">
                            When should I start planning for retirement?
                        </button>
                        <button class="btn btn-outline-primary text-start suggested-question">
                            Is it better to invest in NPS or mutual funds?
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Disclaimer -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Disclaimer</h5>
                </div>
                <div class="card-body">
                    <p class="small">The AI Advisor provides general information and is not a substitute for professional financial advice. All investment suggestions are based on general market knowledge and should be verified with a certified financial advisor before taking action.</p>
                    <p class="small">Market conditions change rapidly, and the information provided may not reflect the most current situation. Always conduct your own research or consult a professional advisor before making financial decisions.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const suggestedQuestions = document.querySelectorAll('.suggested-question');
        
        // Scroll to bottom of chat container
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Handle form submission
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const message = chatInput.value.trim();
            if(!message) return;
            
            // Clear input field
            chatInput.value = '';
            
            // Add user message to chat
            addMessage('user', message);
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator message assistant';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(typingIndicator);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Send message to API
            fetch('/api/v1/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Remove typing indicator
                chatContainer.removeChild(typingIndicator);
                
                // Add AI response
                addMessage('assistant', data.response);
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Remove typing indicator
                chatContainer.removeChild(typingIndicator);
                
                // Add error message
                addMessage('assistant', 'Sorry, I encountered an error. Please try again later.');
            });
        });
        
        // Handle suggested questions
        suggestedQuestions.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.textContent.trim();
                chatInput.value = question;
                
                // Trigger submit event
                const event = new Event('submit', {
                    'bubbles': true,
                    'cancelable': true
                });
                chatForm.dispatchEvent(event);
            });
        });
        
        // Helper function to add message to chat
        function addMessage(role, content) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            
            // Format links
            const formattedContent = content.replace(
                /(https?:\/\/[^\s]+)/g, 
                '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );
            
            messageEl.innerHTML = formattedContent;
            chatContainer.appendChild(messageEl);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
</script>
{% endblock %}